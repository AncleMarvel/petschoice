function N({variantsWithQty:e,email:n,city:s,firstName:t,lastName:i,address:c,zip:d,country:m,phone:y,street:o,house:a,flat:u,selectedPostoffice:S,settlementObject:v}){let F=Object.entries(e).map(([q,P])=>`${q}:${P}`).join(",");const k={"checkout[email]":n,"checkout[shipping_address][city]":s,"checkout[shipping_address][first_name]":t,"checkout[shipping_address][last_name]":i,"checkout[shipping_address][address1]":c,"checkout[shipping_address][zip]":d,"checkout[shipping_address][country]":m,"checkout[shipping_address][phone]":y},O={phone:y,street:o,house:a,flat:u||""};S&&(O.selectedPostoffice=JSON.stringify({selectedPostoffice:S})),v&&(O.settlementObject=JSON.stringify({settlementObject:v})),k.note=JSON.stringify(O);const I=Object.entries(k).map(([q,P])=>`${encodeURIComponent(q)}=${encodeURIComponent(P)}`).join("&");return`https://petschoice.club/cart/${F}?${I}`}const l={fetchedSettlements:[],fetchedPostOffices:[],selectedSettlement:null,selectedPostoffice:null},r={prefillOverlay:"#prefill-overlay",prefillContainer:"#prefill-container",prefillForm:"#prefill-form",closeBtn:"#close-prefill-form",phone:"#phone",shippingType:'[name="shipping-type"]',postOfficeAddressWindow:"#post-office-shipping",searchPostOffice:"#search-post-office",postOfficeSelection:"#post-office",settlementSearch:"#settlement-search",settlementSelection:"#settlement-selection",courierAddressWindow:"#courier-shipping",courierSettlementSearch:"#courier-settlement-search",courierSettlementSelection:"#courier-settlement-selection",courierStreetSearch:"#courier-street-search",courierStreetSelection:"#courier-street-selection",postalCode:"#postal-code",checkoutBtn:'[type="submit"][name="checkout"]',buyNowBtn:".payment-button__prefill-checkout-trigger"};function j(){document.querySelector(r.prefillOverlay).classList.toggle("hidden");const n=document.querySelector("body");n.style.overflow=n.style.overflow==="hidden"?"auto":"hidden"}function A(e){e.preventDefault(),e.stopPropagation(),j()}async function B(e){e.preventDefault(),e.stopPropagation();const n=document.querySelector(r.prefillForm),s=new FormData(n),t={};for(const[o,a]of s.entries())t[o]=a;const i=41899282661450;let c=await fetch("/cart.js").then(o=>o.json()).catch(console.error);if(!c||!c.item_count)return;if(t["payment-type"]==="prepayment"&&!c.items.find(o=>o.variant_id===i)){const o=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:[{id:i,quantity:1}]})}).then(a=>a.json()).catch(console.error);console.log("responseOfAdding --->",o)}else if(t["payment-type"]!=="prepayment"&&c.items.find(o=>o.variant_id===i)){const o={[i]:0},a=await fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({updates:o})}).then(u=>u.json()).catch(console.error);console.log("responseOfRemoving --->",a)}if(c=await fetch("/cart.js").then(o=>o.json()).catch(console.error),t["shipping-type"]==="post-office"){const o=l.fetchedPostOffices.find(v=>v.Ref===l.selectedPostoffice),{PostalCodeUA:a,Description:u,CityDescription:S}=o;t.zip=a,t.address=u,t.city=S,t.selectedPostoffice=o}else{const o=l.fetchedSettlements.find(u=>u.Ref===l.selectedSettlement);let a=`обл. ${o.AreaDescription}, ${o.Description}, ${t.street}, ${t.house}`;t.flat&&(a+=`, кв. ${t.flat}`),t.address=a,t.city=o.Description,t.settlementObject=o}const d={};c.items.forEach(o=>{d[o.variant_id]=o.quantity}),t.variantsWithQty=d,console.log("✌️data --->",t);const m=await fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({note:JSON.stringify(t)})}).then(o=>o.json()).catch(console.error);console.log("✌️response --->",m);const y=N(t);console.log("✌️prefillLink --->",y),window.location.href=y}const x=document.querySelector(r.prefillForm);x.addEventListener("submit",B);const U=document.querySelector(r.closeBtn);U.addEventListener("click",j);const T=document.querySelector(r.prefillContainer);T.addEventListener("click",e=>{e.target===T&&j()});const z=document.querySelector(r.phone);z.addEventListener("input",e=>{const n=e.target.value;n.startsWith("+380")||(e.target.value="+380"+n)});const f=document.querySelector(r.settlementSearch),p=document.querySelector(r.settlementSelection),L=document.querySelector(r.searchPostOffice),w=document.querySelector(r.postOfficeSelection),_="https://api.novaposhta.ua/v2.0/json/",$="a4f8704e04f9ea609b1bd830e1875d7f";async function R(e){const s=await(await fetch(_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:$,modelName:"AddressGeneral",calledMethod:"getSettlements",methodProperties:{FindByString:e,Limit:20}})})).json();return s.success?(l.fetchedSettlements=s.data,s.data):(console.error("Ошибка при получении населенных пунктов:",s.errors),[])}async function H(e,n){const t=await(await fetch(_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:$,modelName:"Address",calledMethod:"getWarehouses",methodProperties:{SettlementRef:e,FindByString:n,Limit:20}})})).json();return t.success?(l.fetchedPostOffices=t.data,t.data):(console.error("Ошибка при получении отделений:",t.errors),[])}function E(e,n,s,t){const i=e.id==="settlement-selection"?"населений пункт":"відділення";e.innerHTML=`<option value="" selected disabled hidden>Оберіть ${i}</option>`,n.forEach(c=>{const d=document.createElement("option");d.value=c[s],Array.isArray(t)?d.textContent=t.map(m=>c[m]).join(", "):d.textContent=c[t],e.appendChild(d)}),e.classList.remove("hidden")}f.addEventListener("input",async e=>{const n=e.target.value.trim();if(n.length<2)return;const s=await R(n);E(p,s,"Ref",["Description","AreaDescription"])});L.addEventListener("input",async e=>{const n=e.target.value.trim(),s=p.value;if(s)f.classList.remove("error"),p.classList.remove("error");else{f.classList.add("error"),p.classList.add("error"),f.scrollIntoView({behavior:"smooth"});return}const t=await H(s,n);E(w,t,"Ref","Description")});p.addEventListener("change",e=>{w.classList.add("hidden"),L.value="",l.selectedSettlement=e.target.value,f.value=`Обрано: ${e.target.selectedOptions[0].innerText}`,f.classList.remove("error"),p.classList.remove("error")});w.addEventListener("change",e=>{l.selectedPostoffice=e.target.value,L.value=`Обрано: ${e.target.selectedOptions[0].innerText}`});L.addEventListener("focus",async()=>{if(l.selectedSettlement)f.classList.remove("error"),p.classList.remove("error");else{f.classList.add("error"),p.classList.add("error"),f.scrollIntoView({behavior:"smooth"});return}});const W=document.querySelector(r.courierSettlementSearch),J=document.querySelector(r.courierSettlementSelection);document.querySelector(r.courierStreetSearch);document.querySelector(r.courierStreetSelection);const C=document.querySelector(r.postalCode);W.addEventListener("input",async e=>{const n=e.target.value.trim();if(n.length<2)return;const s=await R(n);E(J,s,"Ref",["Description","AreaDescription"])});J.addEventListener("change",e=>{const n=e.target.value;l.selectedSettlement=n,W.value=`Обрано: ${e.target.selectedOptions[0].innerText}`;const s=l.fetchedSettlements.find(t=>t.Ref===n);s&&s.IndexCOATSU1?C.value=s.IndexCOATSU1:C.value=""});const b=document.querySelector(r.postOfficeAddressWindow),D=document.querySelector(r.courierAddressWindow),M=document.querySelectorAll(r.shippingType);M.forEach(e=>{e.addEventListener("change",n=>{n.target.value==="post-office"?(b.classList.remove("hidden"),D.classList.add("hidden")):(b.classList.add("hidden"),D.classList.remove("hidden"))})});const Q={41864347975754:1,41864348041290:2},V={variantsWithQty:Q,email:"example@gmail.com",city:"Lviv",firstName:"Nikita",lastName:"Shechenko",address:"Ломоносова,55,кв6",zip:"03022",country:"Ukraine",phone:"+380995586745"};N(V);const g=[];function h(e=null){if(e&&e.type!=="variant:add"){setTimeout(()=>{h()},500);return}const n=document.querySelectorAll(r.checkoutBtn),s=document.querySelectorAll(r.buyNowBtn);n==null||n.forEach(t=>{g.find(i=>i===t)||(t.addEventListener("click",A),g.push(t))}),s==null||s.forEach(t=>{g.find(i=>i===t)||(t.addEventListener("click",A),g.push(t))})}h();document.addEventListener("cart:refresh",h);document.addEventListener("cart:change",h);document.addEventListener("variant:add",h);document.addEventListener("facet:update",h);
